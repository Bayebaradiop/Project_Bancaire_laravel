#!/bin/bash

# Script de diagnostic complet pour voir si les emails partent

echo "=========================================="
echo "DIAGNOSTIC COMPLET EMAIL PRODUCTION"
echo "=========================================="
echo ""

echo "üìã V√âRIFICATIONS √Ä FAIRE SUR RENDER SHELL:"
echo ""
echo "1. V√©rifier que Supervisor tourne:"
echo "   ps aux | grep supervisor"
echo ""
echo "2. V√©rifier que le queue worker tourne:"
echo "   ps aux | grep 'queue:work'"
echo ""
echo "3. Voir les logs du queue worker:"
echo "   tail -100 /var/log/queue-worker.log"
echo ""
echo "4. Voir les derniers logs Laravel (emails):"
echo "   tail -200 storage/logs/laravel.log | grep -i 'email\\|mail\\|CompteCreated\\|SendClientNotification'"
echo ""
echo "5. Compter les jobs en attente:"
echo "   php artisan queue:monitor"
echo ""
echo "6. Voir les failed jobs:"
echo "   php artisan queue:failed"
echo ""
echo "7. Tester l'envoi SMTP direct:"
echo "   php test_smtp_direct.php"
echo ""
echo "=========================================="
echo "ANALYSE DU PROBL√àME"
echo "=========================================="
echo ""
echo "Votre configuration actuelle:"
echo "  ‚úÖ Supervisor configur√© (supervisord.conf)"
echo "  ‚úÖ Queue worker d√©fini (laravel-queue-worker)"
echo "  ‚úÖ Event CompteCreated dispatch√© (CompteService.php:556)"
echo "  ‚úÖ EventServiceProvider enregistr√©"
echo ""
echo "‚ùå MAIS: SendClientNotification n'impl√©mente PAS ShouldQueue"
echo "   ‚Üí Les emails sont envoy√©s DIRECTEMENT (synchrone)"
echo "   ‚Üí Le queue worker NE SERT √Ä RIEN actuellement"
echo ""
echo "Solutions possibles:"
echo ""
echo "A) Si SMTP fonctionne (test r√©ussi):"
echo "   ‚Üí L'email devrait partir imm√©diatement"
echo "   ‚Üí V√©rifier storage/logs/laravel.log"
echo "   ‚Üí Chercher 'Email envoy√©' ou erreur SMTP"
echo ""
echo "B) Si SMTP ne fonctionne pas:"
echo "   ‚Üí V√©rifier les credentials Gmail dans .env Render"
echo "   ‚Üí Tester: php test_smtp_direct.php"
echo ""
echo "C) Si rien ne se passe:"
echo "   ‚Üí Le Listener n'est peut-√™tre pas appel√©"
echo "   ‚Üí V√©rifier EventServiceProvider"
echo "   ‚Üí V√©rifier php artisan event:list"
echo ""
echo "=========================================="
echo "COMMANDES DE DEBUG RENDER"
echo "=========================================="
echo ""
echo "# Voir les 50 derni√®res lignes de logs Laravel"
echo "tail -50 storage/logs/laravel.log"
echo ""
echo "# Chercher les logs d'email"
echo "grep -i 'email\\|mail\\|smtp' storage/logs/laravel.log | tail -20"
echo ""
echo "# Chercher les events dispatch√©s"
echo "grep -i 'CompteCreated\\|Dispatch event' storage/logs/laravel.log | tail -10"
echo ""
echo "# Chercher les erreurs"
echo "grep -i 'error\\|exception\\|failed' storage/logs/laravel.log | tail -20"
echo ""
echo "=========================================="
